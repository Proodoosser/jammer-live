<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Jammer Live</title>
  <style>
    /* === –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò === */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: #18222d;
      color: #ffffff;
      width: 360px;
      height: 640px;
      overflow: hidden;
      position: fixed;
      margin: 0 auto;
      left: 0;
      right: 0;
      border: 1px solid #2f3e4e;
    }
    
    .container {
      width: 100%;
      height: 100%;
      padding: 16px;
      display: flex;
      flex-direction: column;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    }
    
    /* === –ó–ê–ì–û–õ–û–í–û–ö === */
    .header {
      text-align: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(55, 174, 226, 0.3);
    }
    
    h1 {
      font-size: 20px;
      color: #ffffff;
      text-shadow: 0 0 10px rgba(55, 174, 226, 0.5);
    }
    
    /* === –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø === */
    #controls {
      background: rgba(30, 41, 59, 0.9);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 16px;
      border: 1px solid rgba(55, 174, 226, 0.3);
    }
    
    .input-group {
      margin-bottom: 12px;
    }
    
    label {
      display: block;
      font-size: 12px;
      color: #8e9aa3;
      margin-bottom: 4px;
    }
    
    input, select {
      width: 100%;
      padding: 10px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(55, 174, 226, 0.4);
      border-radius: 8px;
      color: #ffffff;
      font-size: 14px;
    }
    
    .teacher-auth {
      display: none;
      background: rgba(255, 193, 7, 0.1);
      border: 1px solid rgba(255, 193, 7, 0.3);
      border-radius: 8px;
      padding: 10px;
      margin-top: 8px;
    }
    
    /* === –ö–ù–û–ü–ö–ò === */
    .button-group {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    
    button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    #joinBtn {
      background: linear-gradient(135deg, #37aee2, #1e96c8);
      color: white;
    }
    
    #leaveBtn {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* === –í–ò–î–ï–û –ö–û–ù–¢–ï–ô–ù–ï–† === */
    .video-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
      min-height: 200px;
    }
    
    .video-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      height: 150px;
    }
    
    .video-wrapper {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: #000;
      border: 2px solid rgba(55, 174, 226, 0.3);
      transition: all 0.3s ease;
    }
    
    .video-wrapper.active {
      border-color: #37aee2;
      box-shadow: 0 0 15px rgba(55, 174, 226, 0.3);
    }
    
    .video-wrapper.fullscreen {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      height: 60%;
      z-index: 1000;
      border: 3px solid #37aee2;
    }
    
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .video-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
      padding: 8px;
      color: white;
      font-size: 11px;
    }
    
    .video-controls {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 4px;
    }
    
    .control-btn {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.5);
      border: none;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
    }
    
    /* === –í–û–õ–ù–´ –ì–û–õ–û–°–ê === */
    .voice-waves {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 16px;
      margin-top: 4px;
    }
    
    .wave {
      width: 3px;
      background: #37aee2;
      border-radius: 2px;
      transition: height 0.2s ease;
    }
    
    /* === –°–¢–ê–¢–£–° –ë–ê–† === */
    .status-bar {
      background: rgba(30, 41, 59, 0.9);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid rgba(55, 174, 226, 0.3);
      font-size: 12px;
    }
    
    .status-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    
    .status-value {
      color: #37aee2;
      font-weight: 500;
    }
    
    /* === –ß–ê–¢ === */
    .chat-section {
      position: relative;
      margin-bottom: 12px;
    }
    
    .chat-handle {
      position: absolute;
      top: -25px;
      right: 10px;
      width: 40px;
      height: 25px;
      background: rgba(55, 174, 226, 0.8);
      border-radius: 12px 12px 0 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
      cursor: pointer;
      z-index: 10;
    }
    
    #chat {
      height: 120px;
      border: 1px solid rgba(55, 174, 226, 0.3);
      border-radius: 12px;
      padding: 10px;
      overflow-y: auto;
      background: rgba(15, 23, 42, 0.8);
      margin-bottom: 8px;
    }
    
    .msg {
      margin-bottom: 6px;
      padding: 6px;
      border-radius: 6px;
      background: rgba(55, 174, 226, 0.1);
      font-size: 11px;
    }
    
    .chat-input-group {
      display: flex;
      gap: 8px;
    }
    
    #chatInput {
      flex: 1;
      margin: 0;
      padding: 8px;
      font-size: 12px;
    }
    
    #sendChatBtn {
      padding: 8px 12px;
      font-size: 12px;
    }
    
    /* === –õ–û–ì === */
    #log {
      height: 80px;
      border: 1px solid rgba(55, 174, 226, 0.3);
      border-radius: 8px;
      padding: 8px;
      overflow-y: auto;
      background: rgba(15, 23, 42, 0.8);
      font-size: 10px;
      margin-bottom: 8px;
    }
    
    .log-entry {
      margin-bottom: 4px;
      padding: 4px;
      border-radius: 4px;
      background: rgba(55, 174, 226, 0.1);
    }
    
    /* === –ê–ù–ò–ú–ê–¶–ò–ò === */
    @keyframes wave {
      0%, 100% { height: 4px; }
      50% { height: 16px; }
    }
    
    .wave.active {
      animation: wave 1.5s infinite;
    }
    
    .wave:nth-child(2) { animation-delay: 0.2s; }
    .wave:nth-child(3) { animation-delay: 0.4s; }
    .wave:nth-child(4) { animation-delay: 0.6s; }
    .wave:nth-child(5) { animation-delay: 0.8s; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üé∏ Jammer Live</h1>
    </div>
    
    <div id="controls">
      <div class="input-group">
        <label>Room ID</label>
        <input type="text" id="roomId" value="lesson123">
      </div>
      
      <div class="input-group">
        <label>Role</label>
        <select id="roleSelect">
          <option value="student">Student</option>
          <option value="teacher">Teacher</option>
        </select>
      </div>
      
      <div class="teacher-auth" id="teacherAuth">
        <label>Teacher Password</label>
        <input type="password" id="teacherPassword" placeholder="Enter password">
      </div>
      
      <div class="button-group">
        <button id="joinBtn">Join</button>
        <button id="leaveBtn" disabled>Leave</button>
      </div>
    </div>
    
    <div class="video-section">
      <div class="video-grid">
        <div class="video-wrapper" id="localVideoWrapper">
          <video id="localVideo" autoplay playsinline muted></video>
          <div class="video-overlay">
            <div>You</div>
            <div class="voice-waves">
              <div class="wave" id="localWave1"></div>
              <div class="wave" id="localWave2"></div>
              <div class="wave" id="localWave3"></div>
              <div class="wave" id="localWave4"></div>
              <div class="wave" id="localWave5"></div>
            </div>
          </div>
          <div class="video-controls">
            <button class="control-btn" onclick="toggleFullscreen('localVideoWrapper')">‚õ∂</button>
          </div>
        </div>
        
        <div class="video-wrapper" id="remoteVideoWrapper">
          <video id="remoteVideo" autoplay playsinline></video>
          <div class="video-overlay">
            <div>Remote</div>
            <div class="voice-waves">
              <div class="wave" id="remoteWave1"></div>
              <div class="wave" id="remoteWave2"></div>
              <div class="wave" id="remoteWave3"></div>
              <div class="wave" id="remoteWave4"></div>
              <div class="wave" id="remoteWave5"></div>
            </div>
          </div>
          <div class="video-controls">
            <button class="control-btn" onclick="toggleFullscreen('remoteVideoWrapper')">‚õ∂</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="status-bar">
      <div class="status-item">
        <span>Status:</span>
        <span class="status-value" id="status">not connected</span>
      </div>
      <div class="status-item">
        <span>Room:</span>
        <span class="status-value" id="showRoom">-</span>
      </div>
      <div class="status-item">
        <span>SocketID:</span>
        <span class="status-value" id="socketId">-</span>
      </div>
    </div>
    
    <div class="chat-section">
      <div class="chat-handle" onclick="toggleChat()">üí¨</div>
      <div id="chat"></div>
      <div class="chat-input-group">
        <input type="text" id="chatInput" placeholder="Message..." disabled>
        <button id="sendChatBtn" disabled>Send</button>
      </div>
    </div>
    
    <div id="log"></div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const SIGNALING_SERVER = location.hostname === "localhost" || location.hostname === "127.0.0.1"
      ? "http://localhost:3000"
      : window.location.origin;

    const ICE_CONFIG = {
      iceServers: [
        {
          urls: [
            "stun:fr-turn3.xirsys.com",
            "turn:fr-turn3.xirsys.com:80?transport=udp",
            "turn:fr-turn3.xirsys.com:3478?transport=udp",
            "turn:fr-turn3.xirsys.com:80?transport=tcp",
            "turn:fr-turn3.xirsys.com:3478?transport=tcp",
            "turns:fr-turn3.xirsys.com:443?transport=tcp",
            "turns:fr-turn3.xirsys.com:5349?transport=tcp"
          ],
          username: "B0UKGM_7iTKBEwxa1dB6bNj18YKk4Vm-Fo7a3ddF4G8gshE2GgC_0tLJnF8DGtPnAAAAAGjHzn1Qcm9kb29zc2Vy",
          credential: "24cbbacc-920e-11f0-82f1-e25abca605ee",
        },
      ],
    };

    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const joinBtn = document.getElementById("joinBtn");
    const leaveBtn = document.getElementById("leaveBtn");
    const roomIdInput = document.getElementById("roomId");
    const roleSelect = document.getElementById("roleSelect");
    const teacherAuth = document.getElementById("teacherAuth");
    const teacherPassword = document.getElementById("teacherPassword");
    const statusSpan = document.getElementById("status");
    const showRoom = document.getElementById("showRoom");
    const socketIdSpan = document.getElementById("socketId");
    const logEl = document.getElementById("log");
    const chatEl = document.getElementById("chat");
    const chatInput = document.getElementById("chatInput");
    const sendChatBtn = document.getElementById("sendChatBtn");

    let socket = null;
    let pc = null;
    let localStream = null;
    let roomId = null;
    let role = null;
    let peerSocketId = null;
    let isChatExpanded = false;

    // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
    function toggleChat() {
      const chat = document.getElementById('chat');
      isChatExpanded = !isChatExpanded;
      chat.style.height = isChatExpanded ? '200px' : '120px';
    }

    function toggleFullscreen(videoId) {
      const videoWrapper = document.getElementById(videoId);
      videoWrapper.classList.toggle('fullscreen');
    }

    function toggleTeacherAuth() {
      teacherAuth.style.display = roleSelect.value === 'teacher' ? 'block' : 'none';
    }

    function updateVoiceWaves() {
      const waves = document.querySelectorAll('.wave');
      waves.forEach(wave => {
        if (Math.random() > 0.3) {
          wave.classList.add('active');
        } else {
          wave.classList.remove('active');
        }
      });
    }

    // –£—Ç–∏–ª–∏—Ç—ã
    function log(msg) {
      const d = document.createElement("div");
      d.className = "log-entry";
      d.textContent = msg;
      logEl.appendChild(d);
      logEl.scrollTop = logEl.scrollHeight;
    }
    
    function addChat(user, text) {
      const d = document.createElement("div");
      d.className = "msg";
      d.innerHTML = `<b>${user}:</b> ${text}`;
      chatEl.appendChild(d);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // WebRTC —Ñ—É–Ω–∫—Ü–∏–∏
    async function startLocalMedia() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({
          video: true,
          audio: true,
        });
        localVideo.srcObject = localStream;
        log("Media devices activated");
      } catch (e) {
        alert("Error accessing media devices: " + e.message);
        throw e;
      }
    }

    function createPeerConnection() {
      pc = new RTCPeerConnection(ICE_CONFIG);

      if (localStream) {
        localStream.getTracks().forEach((track) =>
          pc.addTrack(track, localStream)
        );
      }

      pc.ontrack = (evt) => {
        log("Remote stream received");
        remoteVideo.srcObject = evt.streams[0];
        statusSpan.textContent = "connected";
      };

      pc.onicecandidate = (evt) => {
        if (evt.candidate && peerSocketId) {
          socket.emit("ice-candidate", { to: peerSocketId, candidate: evt.candidate });
          log("ICE candidate sent");
        }
      };

      pc.onconnectionstatechange = () => {
        statusSpan.textContent = pc.connectionState;
        log("Connection state: " + pc.connectionState);
      };
    }

    async function makeOffer() {
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.emit("offer", { to: peerSocketId, sdp: pc.localDescription });
      log("Offer sent");
    }

    // Socket —Ñ—É–Ω–∫—Ü–∏–∏
    function setupSocket() {
      socket = io(SIGNALING_SERVER);

      socket.on("connect", () => {
        socketIdSpan.textContent = socket.id;
        log("Connected to signaling server");
        socket.emit("join-room", roomId, role);
      });

      socket.on("peer-joined", ({ id, role: r }) => {
        log("Peer joined: " + id);
        if (role !== r) {
          peerSocketId = id;
          if (role === "teacher") {
            makeOffer();
          }
        }
      });

      socket.on("offer", async ({ from, sdp }) => {
        if (role === "student") {
          log("Offer received from " + from);
          peerSocketId = from;
          if (!pc) createPeerConnection();
          await pc.setRemoteDescription(new RTCSessionDescription(sdp));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          socket.emit("answer", { to: from, sdp: pc.localDescription });
          log("Answer sent");
        }
      });

      socket.on("answer", async ({ from, sdp }) => {
        log("Answer received from " + from);
        await pc.setRemoteDescription(new RTCSessionDescription(sdp));
      });

      socket.on("ice-candidate", async ({ from, candidate }) => {
        if (pc) {
          try {
            await pc.addIceCandidate(candidate);
            log("ICE candidate added from " + from);
          } catch (e) {
            console.warn("Error adding candidate", e);
          }
        }
      });

      socket.on("peer-left", ({ id }) => {
        log("Peer left: " + id);
        addChat("system", "Peer disconnected");
        if (pc) {
          pc.close();
          pc = null;
        }
        remoteVideo.srcObject = null;
      });

      socket.on("message", ({ user, text }) => {
        addChat(user, text);
      });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    joinBtn.onclick = async () => {
      roomId = roomIdInput.value.trim();
      role = roleSelect.value;
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è –¥–ª—è —É—á–∏—Ç–µ–ª—è
      if (role === "teacher" && teacherPassword.value !== "teacher123") {
        alert("Invalid teacher password");
        return;
      }

      if (!roomId) return alert("Enter Room ID");

      showRoom.textContent = roomId;
      statusSpan.textContent = "connecting...";
      joinBtn.disabled = true;
      leaveBtn.disabled = false;
      chatInput.disabled = false;
      sendChatBtn.disabled = false;

      await startLocalMedia();
      createPeerConnection();
      setupSocket();
    };

    leaveBtn.onclick = () => {
      if (socket) socket.disconnect();
      if (pc) {
        pc.close();
        pc = null;
      }
      if (localStream) {
        localStream.getTracks().forEach((t) => t.stop());
        localStream = null;
      }
      remoteVideo.srcObject = null;
      localVideo.srcObject = null;
      joinBtn.disabled = false;
      leaveBtn.disabled = true;
      chatInput.disabled = true;
      sendChatBtn.disabled = true;
      statusSpan.textContent = "not connected";
      log("Left room");
    };

    sendChatBtn.onclick = () => {
      const text = chatInput.value.trim();
      if (!text) return;
      if (socket) socket.emit("message", { room: roomId, user: role, text });
      chatInput.value = "";
    };

    roleSelect.addEventListener('change', toggleTeacherAuth);
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –≤–æ–ª–Ω
    setInterval(updateVoiceWaves, 300);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    toggleTeacherAuth();
  </script>
</body>
</html>