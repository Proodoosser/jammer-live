// app.js — Jammer (Telegram style)

const socket = io();
let pc;
let localStream;
let remoteStream;

// DOM refs
const roomInput = document.getElementById("roomId");
const roleSelect = document.getElementById("roleSelect");
const joinBtn = document.getElementById("joinBtn");
const leaveBtn = document.getElementById("leaveBtn");
const statusEl = document.getElementById("status");
const chatArea = document.getElementById("chatArea");
const chatInput = document.getElementById("chatInput");
const sendChatBtn = document.getElementById("sendChatBtn");
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");

// helpers
function setStatus(txt) {
  if (statusEl) statusEl.textContent = txt;
}

function addChat(user, text) {
  if (typeof window.addChat === "function") {
    window.addChat(user, text);
  } else {
    const div = document.createElement("div");
    div.textContent = `${user}: ${text}`;
    chatArea.appendChild(div);
    chatArea.scrollTop = chatArea.scrollHeight;
  }
}

// ---- join / leave ----
async function joinAs(role) {
  const roomId = roomInput.value.trim();
  if (!roomId) {
    alert("Enter room id");
    return;
  }
  setStatus("Connecting…");
  joinBtn.disabled = true;

  // create peerconnection
  pc = new RTCPeerConnection({
    iceServers: [
      {
        urls: "turn:global.xirsys.net:3478?transport=udp",
        username: "Prodoosser",
        credential: "c673ce8e-920c-11f0-8f21-4662eff0c0a9",
      },
      {
        urls: "turn:global.xirsys.net:3478?transport=tcp",
        username: "Prodoosser",
        credential: "c673ce8e-920c-11f0-8f21-4662eff0c0a9",
      },
    ],
    iceTransportPolicy: "relay",
  });

  // remote track
  remoteStream = new MediaStream();
  remoteVideo.srcObject = remoteStream;
  pc.ontrack = (e) => {
    e.streams[0].getTracks().forEach((t) => remoteStream.addTrack(t));
  };

  // ICE
  pc.onicecandidate = (e) => {
    if (e.candidate) {
      socket.emit("candidate", { candidate: e.candidate, roomId });
    }
  };

  // local media
  try {
    localStream = await navigator.mediaDevices.getUserMedia({
      audio: {
        channelCount: 2,
        echoCancellation: true,
        noiseSuppression: true,
      },
      video: { width: { ideal: 1280 }, height: { ideal: 720 } },
    });
    localVideo.srcObject = localStream;
    localStream.getTracks().forEach((t) => pc.addTrack(t, localStream));
  } catch (err) {
    console.error("getUserMedia error", err);
    alert("Could not access mic/camera");
    return;
  }

  // socket events
  socket.emit("join", { roomId, role });

  socket.on("offer", async (offer) => {
    await pc.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await pc.createAnswer();
    preferOpus(answer);
    await pc.setLocalDescription(answer);
    socket.emit("answer", { answer, roomId });
  });

  socket.on("answer", async (answer) => {
    await pc.setRemoteDescription(new RTCSessionDescription(answer));
  });

  socket.on("candidate", async (msg) => {
    try {
      await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
    } catch (err) {
      console.error("ICE add error", err);
    }
  });

  socket.on("chat", (msg) => {
    addChat(msg.user, msg.text);
  });

  setStatus("Connected");
  leaveBtn.disabled = false;
}

function leaveRoom() {
  if (pc) {
    pc.close();
    pc = null;
  }
  if (socket) {
    socket.emit("leave", { roomId: roomInput.value });
  }
  if (localStream) {
    localStream.getTracks().forEach((t) => t.stop());
    localStream = null;
  }
  localVideo.srcObject = null;
  remoteVideo.srcObject = null;
  setStatus("Disconnected");
  joinBtn.disabled = false;
  leaveBtn.disabled = true;
}

// prefer Opus
function preferOpus(desc) {
  if (!desc.sdp) return;
  const lines = desc.sdp.split("\n");
  const mLineIndex = lines.findIndex((l) => l.startsWith("m=audio"));
  if (mLineIndex === -1) return;
  const opusIdx = lines.findIndex(
    (l) => l.toLowerCase().includes("opus/48000")
  );
  if (opusIdx === -1) return;
  const opusPayload = lines[opusIdx].match(/:(\d+)/)[1];
  const mLine = lines[mLineIndex].split(" ");
  const newLine = [
    mLine[0],
    mLine[1],
    mLine[2],
    opusPayload,
    ...mLine.slice(3).filter((x) => x !== opusPayload),
  ];
  lines[mLineIndex] = newLine.join(" ");
  desc.sdp = lines.join("\n");
}

// ---- wire UI ----
joinBtn.onclick = () => joinAs(roleSelect.value);
leaveBtn.onclick = () => leaveRoom();

sendChatBtn.onclick = () => {
  const text = chatInput.value.trim();
  if (!text) return;
  const roomId = roomInput.value.trim();
  const role = roleSelect.value;
  addChat(role, text);
  socket.emit("chat", { roomId, user: role, text });
  chatInput.value = "";
};
