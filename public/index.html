// public/app.js

const socket = io();
let localStream = null;
let pc = null;
let remoteStream = null;
let role = null;

const statusEl = document.getElementById("status");
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const joinTeacherBtn = document.getElementById("join-teacher");
const joinStudentBtn = document.getElementById("join-student");
const leaveBtn = document.getElementById("leave");
const chatArea = document.getElementById("chatArea");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");

// ----------- Utility -----------
function log(msg) {
  console.log(msg);
  if (statusEl) statusEl.textContent = msg;
}

function addChat(msg, who = "system") {
  if (!chatArea) return;
  const div = document.createElement("div");
  div.className =
    who === "me"
      ? "chat-bubble me"
      : who === "other"
      ? "chat-bubble other"
      : "chat-bubble system";
  div.textContent = msg;
  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;
}

// ----------- Media Setup -----------
async function initMedia() {
  try {
    log("Запрос getUserMedia...");
    localStream = await navigator.mediaDevices.getUserMedia({
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        autoGainControl: true
      },
      video: true
    });
    if (localVideo) localVideo.srcObject = localStream;
    log("Микрофон и камера получены");
  } catch (err) {
    console.error("Ошибка getUserMedia:", err);
    alert("Не удалось получить доступ к камере/микрофону");
  }
}

// ----------- Peer Connection -----------
function createPeerConnection() {
  log("Создаем RTCPeerConnection...");

  pc = new RTCPeerConnection({
    iceServers: [
      {
        urls: [
          "stun:stun.l.google.com:19302"
        ]
      },
      {
        urls: [
          "turn:global.xirsys.net:3478?transport=udp",
          "turn:global.xirsys.net:3478?transport=tcp"
        ],
        username: "Prodoosser",
        credential: "c673ce8e-920c-11f0-8f21-4662eff0c0a9"
      }
    ],
    iceTransportPolicy: "relay"
  });

  remoteStream = new MediaStream();
  if (remoteVideo) remoteVideo.srcObject = remoteStream;

  pc.onicecandidate = (event) => {
    if (event.candidate) {
      log("ICE candidate отправлен");
      socket.emit("candidate", event.candidate);
    }
  };

  pc.ontrack = (event) => {
    log("ontrack вызван, track.kind=" + event.track.kind);
    if (event.streams && event.streams[0]) {
      log("Назначаем remoteVideo поток");
      if (remoteVideo) remoteVideo.srcObject = event.streams[0];
    } else {
      log("Добавляем track вручную в remoteStream");
      remoteStream.addTrack(event.track);
    }
  };

  pc.onconnectionstatechange = () => {
    log("connectionState: " + pc.connectionState);
  };

  if (localStream) {
    localStream.getTracks().forEach((track) => {
      pc.addTrack(track, localStream);
    });
    log("Добавлены локальные треки");
  }
}

// ----------- Signaling -----------
async function makeOffer() {
  createPeerConnection();
  const offer = await pc.createOffer();
  let sdp = preferOpus(offer.sdp);
  await pc.setLocalDescription({ type: "offer", sdp });
  log("Offer создан и локально установлен");
  socket.emit("offer", pc.localDescription);
}

async function handleOffer(offer) {
  createPeerConnection();
  await pc.setRemoteDescription(new RTCSessionDescription(offer));
  const answer = await pc.createAnswer();
  let sdp = preferOpus(answer.sdp);
  await pc.setLocalDescription({ type: "answer", sdp });
  log("Answer создан и локально установлен");
  socket.emit("answer", pc.localDescription);
}

async function handleAnswer(answer) {
  await pc.setRemoteDescription(new RTCSessionDescription(answer));
  log("Answer применен как удаленный SDP");
}

async function handleCandidate(candidate) {
  try {
    await pc.addIceCandidate(new RTCIceCandidate(candidate));
    log("ICE candidate добавлен");
  } catch (e) {
    console.error("Ошибка добавления candidate", e);
  }
}

// ----------- SDP Helpers -----------
function preferOpus(sdp) {
  const lines = sdp.split("\r\n");
  let mLineIndex = null;
  for (let i = 0; i < lines.length; i++) {
    if (lines[i].indexOf("m=audio") === 0) {
      mLineIndex = i;
      break;
    }
  }
  if (mLineIndex === null) return sdp;

  for (let i = 0; i < lines.length; i++) {
    if (lines[i].toLowerCase().includes("opus/48000")) {
      const opusPayload = lines[i].match(/:(\d+) /)[1];
      const mLine = lines[mLineIndex].split(" ");
      const newLine = [mLine[0], mLine[1], mLine[2], opusPayload].concat(
        mLine.slice(3).filter((pt) => pt !== opusPayload)
      );
      lines[mLineIndex] = newLine.join(" ");
      break;
    }
  }
  return lines.join("\r\n");
}

// ----------- Socket Events -----------
socket.on("connect", () => {
  log("Соединение с сервером установлено");
});

socket.on("offer", handleOffer);
socket.on("answer", handleAnswer);
socket.on("candidate", handleCandidate);

socket.on("chat", (msg) => {
  addChat(msg, "other");
});

// ----------- UI Buttons -----------
async function joinAs(r) {
  role = r;
  await initMedia();
  if (role === "teacher") {
    makeOffer();
  }
  socket.emit("join", role);
  log("Вы вошли как " + role);
}

if (joinTeacherBtn) {
  joinTeacherBtn.onclick = () => joinAs("teacher");
}
if (joinStudentBtn) {
  joinStudentBtn.onclick = () => joinAs("student");
}
if (leaveBtn) {
  leaveBtn.onclick = () => {
    if (pc) pc.close();
    if (localVideo) localVideo.srcObject = null;
    if (remoteVideo) remoteVideo.srcObject = null;
    log("Вышли из комнаты");
    socket.emit("leave");
  };
}
if (sendBtn) {
  sendBtn.onclick = () => {
    const msg = chatInput.value.trim();
    if (msg) {
      addChat(msg, "me");
      socket.emit("chat", msg);
      chatInput.value = "";
    }
  };
}
